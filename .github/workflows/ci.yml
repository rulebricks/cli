name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18, 20, 22]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npm run typecheck

      - name: Build
        run: npm run build

      - name: Verify CLI runs
        run: node dist/index.js --help

  # Test standalone binary creation on main platforms
  binary-test:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: build
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: node20-linux-x64
          - os: macos-latest
            target: node20-macos-arm64
          - os: windows-latest
            target: node20-win-x64

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Install pkg
        run: npm install -g @yao-pkg/pkg

      - name: Create binary
        run: pkg . --target ${{ matrix.target }} --output rulebricks-test

      - name: Test binary (Unix)
        if: matrix.os != 'windows-latest'
        run: |
          chmod +x rulebricks-test
          ./rulebricks-test --help

      - name: Test binary (Windows)
        if: matrix.os == 'windows-latest'
        run: .\rulebricks-test.exe --help
